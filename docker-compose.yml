# Docker Compose for User Management System

services:
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_DATABASE: management_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: root_password
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  api:
    # build:
    #   context: ./backend
    #   dockerfile: Dockerfile
    image: ${DOCKER_USERNAME}/fastapi-backend:latest
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure
    environment:
      MYSQL_SERVER: db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DB: management_db
      MYSQL_PORT: 3306
      PROJECT_NAME: "User Management System"
      SECRET_KEY: dev_secret_key_change_me
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7
      BACKEND_CORS_ORIGINS: '["http://localhost", "http://localhost:3000", "http://127.0.0.1", "http://localhost:80", "http://100.31.1.33", "http://100.31.1.33:80"]'
    ports:
      - "8000:8000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - sh
      - -c
      - |
        echo "Waiting for database..."
        python -c "import socket, time; 
        while True:
            try:
                with socket.create_connection(('db', 3306), timeout=1):
                    break
            except:
                time.sleep(1)"
        echo "Database is up - running migrations..."
        alembic upgrade head
        echo "Starting application..."
        uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - app_network

  frontend:
    # build:
    #   context: ./frontend
    #   dockerfile: Dockerfile
    #   args:
    #     - VITE_API_URL=/api/v1
    image: ${DOCKER_USERNAME}/fastapi-frontend:latest
    restart: always
    ports:
      - "80:80"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80" ]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

volumes:
  db_data:
